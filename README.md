# Recognition of curvature on spine X-ray images
## License
Authors: Yann Bachelot, Maxime Carlier, Dimitri Mikec, Luka Matsuda, Jiri Ruzicka.
Supervised by Noelie Debs and Carole Frindel.
The code is open source which means anyone can see and download our code from the Github repository.
The code implemented here is part of the final project of the class Image Analysis at INSA Lyon engineering school (Bioinformatics and Modeling specialty).


## Objective of the project
The objective of this project is to allow aid to surgical planning through the analysis of profile X-ray images by providing a computer routine that allows automatic identification of the column.

## Implementation
Our code follows the following steps: contrasting the image, filtering, detecting the beginning and end of the spine, detecting the key points, selecting the points of interest, fitting the curve, computing some statistical measures.
Inputs: 
Dataset of 30 X-ray images of 30 patients in profile (JPEG format, EOS acquisition system). The X-rays look like conventional radiography: the contrast of which depends on the attenuation coefficient of the structures traversed.
Outputs: 
Same 30 images with key points and the associated curve that fit the spine also drawn on each image.
3 folders containing all the images, corresponding to 3 different detection methods: Hough transform, Harris detection algorithm and SIFT algorithm.
Compute of the MSE (Mean Square Error) for each image.
Parameters: The parameters used in each function were either optimize by testing several values and checking directly visually or thanks to predefined techniques. For more details please refer to the description of the file you’re interested in below.
Files
canny.m
This script is used to find edges in each image.
It outputs binary images with detected edges.
We used the edge function implemented on Matlab with a threshold of 0.3.
This threshold seemed to be working the best as it kept enough edges without too many details.
hough_script.m
This script is used to find the curvature with the Hough algorithm.
It uses images generated by canny.m.
It outputs each input image with lines found with the Hough algorithm.
hough, houghpeaks and houghlines MATLAB functions were used to perform analysis.
Default parameters were used for hough and houghlines functions. For houghpeaks we used numpeaks=5.
We also only considered more or less vertical lines (>60 degrees to the horizontal axis) as most horizontal lines were of no interest.
spatial_filter.m
This script is used to filter our images. As an input, you need to load the image you want to apply the filter to. The output is an image that compares 3 different filters (Gaussian, Median, Anisotropic) to the original image.
beginning_boundary.m
This script is a function and is used to get column and line coordinates of the beginning of the spine for each image. As an input, you need to load the contrasted image and the line in order to crop the image correctly and only get the high part of the image. The output is an image where the beginning is identified, the column coordinate and the line coordinate.
end_boundary.m
This script is a function and is used to get column and line coordinates of the end of the spine for each image. As an input, you need to load the contrasted image and the line in order to crop the image correctly and only get the low part of the image. The output is an image where the end is identified, the column coordinate and the line coordinate.
harris_detection.m
This script is used to detect keypoints using Harris method and then select the points that we want, that is to say, the ones on the spine. We used the detectHarrisFeatures with the parameter MinQuality set to 0.005. Then to select only the points that we judge interesting, we first find all the points corresponding to the right delimitation of the body (based on pixel intensity). We then define an interval in which we keep only the keypoints that are in this interval - between 200 and 10 pixels left from the points of the right part of the body. We also check if all our keypoints are not in the left-most third part of the image.
We also compute the polyfit function to find the function that fits the curvature of the spine. The degree of the function is found as followed: it is always between 4 and 8 and otherwise depends on the number of keypoints we have.
Finally, we compute the LSE (Least Squared Error).
The output is the new images with the curve of the spine drawn on top.
keypoints.m
Contains the function SIFT we used in the script test_keypoints.m.

test_keypoints.m
This script is used to detect keypoints using SIFT method and then select the points that we want, that is to say, the ones on the spine. This script differs from the Harris one only for the detecting method used, the selection process is the same for both.
contrast_image.m
Here we find the function which pre-process the images to improve the visibility of the spine. The pre-processing contrast method was chosen after comparison of different methods, from histogram equalization to linear transformations. The retained method was linear transformation with saturation. Because the ideal saturation levels are not the same in different parts of image (notably in the skull area), we cropped images in three parts and applied adapted saturation in every part of image. The detection of cropping levels were based on physiological features which translate themselves into white pixels.
In the end, the final pre-preprocessed images are saved as the composition of three differently treated sections.

contrast.m
Calls the functions which process the image and find the beginning and the end of the spine.
Output of the script are the new images and detected boundaries of the spine as well as the separation_coordinates.txt file.

test.m
Contains functions to find the best pre-processing method.


## User's manual
In order to use our code, you must upload the images you want to do the processing on in the folder Data.
Then you must first run the script contrast.m to preprocess the images. It will automatically call the scripts beginning_boundary.m and end_boundary.m. Finally, either run harris_detection.m, test_keypoints.m, or hough_script.m depending on which method you want to use.


## Software requirements
Matlab®️ : tested with version R2018b or more recent.
Toolbox Computer vision in Matlab to have access to Harris detection functions.

